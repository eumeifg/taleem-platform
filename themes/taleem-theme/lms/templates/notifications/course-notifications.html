## mako

<%! main_css = "style-main-v2" %>

<%page expression_filter="h"/>
<%inherit file="../main.html" />
<%namespace name='static' file='../static_content.html'/>
<%def name="online_help_token()"><% return "courseware" %></%def>
<%def name="course_name()">
<% return _("{course_number} Courseware").format(course_number=course.display_number_with_default) %>
</%def>

<%!
import json
from django.utils.translation import ugettext as _
from django.utils.translation import get_language_bidi
from django.template.defaultfilters import escapejs
from lms.djangoapps.discussion.django_comment_client.permissions import has_permission
from openedx.core.djangolib.js_utils import dump_js_escaped_json, js_escaped_string
from openedx.core.djangolib.markup import HTML
from openedx.features.course_experience import course_home_page_title
%>

<%block name="bodyclass">course</%block>

<%block name="pagetitle">${course_name()}</%block>

<%include file="../courseware/course_navigation.html" args="active_page='courseware'" />

<%block name="head_extra">
<link rel="stylesheet" href="https://phpcoder.tech/multiselect/css/jquery.multiselect.css">
<style>
.error {color: red;}
.ms-options ul li {list-style-type: none;}
.ms-options-wrap > .ms-options > ul input[type="checkbox"] {top: 14px;}
% if get_language_bidi():
.ms-options-wrap > button:focus, .ms-options-wrap > button {text-align: right;}
.ms-options-wrap > .ms-options {text-align: right;}
.ms-options-wrap > .ms-options > ul input[type="checkbox"] {left: unset; right: 4px; margin-right: unset; margin-left: 5px;}
.ms-options-wrap > .ms-options > ul label {padding-left: unset !important; padding-right: 23px !important;}
% endif
</style>
</%block>

<%block name="footer_extra">
<script src="https://phpcoder.tech/multiselect/js/jquery.multiselect.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
% if get_language_bidi():
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/localization/messages_ar.min.js"></script>
% endif
<script>
$('#studentSelect').multiselect({
    columns: 1,
    placeholder: '${_("Select students")}',
    search: true,
    searchOptions: {default: gettext("Search")},
    selectAll: true,
    onLoad: function( element ) {
        $(element).hide();
        $(".ms-selectall.global").html(gettext("Select all"));
    }
});
$(function(){
    $('#studentSelect').change(function(e){
        var paramValue = this.value;

        if(paramValue.length > 0) {
            $('#send').removeAttr('disabled');
        } else {
            $('#send').attr('disabled', '');
        }
    });

    $("#notification-form").validate({
        submitHandler: function(form) {
            $('#send').attr('disabled', '').html('<i class="fa fa-spin fa-refresh"></i>');
            $.post({
                url: ".",
                data: JSON.stringify({
                    students: $("#studentSelect").val(),
                    message: $("#message").val(),
                    resolve_link: $("#resolveLink").val(),
                }),
                success: function(res) {
                    $("#notification-status")
                        .addClass('text-success')
                        .removeClass('text-danger')
                        .text('${_("Notification sent successfully.")}');
                    $("#notification-form").trigger("reset");
                    $(".ms-options-wrap button").text('${_("Select students")}');
                    $('#send').removeAttr('disabled').html('').text('${_("Send Notification")}');
                },
                error: function() {
                    $("#notification-status")
                        .addClass('text-danger')
                        .removeClass('text-success')
                        .text('${_("Something went wrong! Please try again after sometime.")}');
                    $('#send').removeAttr('disabled').html('').text('${_("Send Notification")}');
                },
                complete: function() {
                    $(".ms-options ul li.selected").removeClass('selected');
                }
            });
        }
    });
});
</script>
</%block>

<%block name="content">
<div class="course-view page-content-container" id="course-container">
    <header class="page-header has-secondary">
        ## Breadcrumb navigation
        <div class="page-header-main">
            <nav aria-label="${_('Announcements')}" class="sr-is-focusable" tabindex="-1">
                <div class="has-breadcrumbs">
                    <div class="breadcrumbs">
                        <span class="nav-item">
                            <a href="${course_url}">${course_home_page_title(course)}</a>
                        </span>
                        <span class="icon fa fa-angle-right" aria-hidden="true"></span>
                        <span class="nav-item">${_('Announcements')}</span>
                    </div>
                </div>
            </nav>
        </div>
    </header>
    <div class="page-content">
        <div class="row">
            <div class="col-md-8">
                <form id="notification-form">
                    <p class="text-success font-weight-bold" id="notification-status"></p>
                    <div class="form-group">
                        <label for="studentSelect">${_("Select the students to send notification")}</label>
                        <select name="students[]" multiple id="studentSelect" required>
                        % for enrollment in enrollments:
                        <option value="${enrollment.user.id}">${enrollment.user.profile.name}</option>
                        % endfor
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="message">${_("Enter a notification message")}</label>
                        <textarea class="form-control" id="message" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="resolveLink">${_("Enter URL")} (${_("Optional")})</label>
                        <input id="resolveLink" class="form-control"
                            type="url" name="resolve_link" />
                    </div>
                    <div class="form-group">
                        <button id="send" class="btn btn-primary" type="submit" disabled>${_("Announce")}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
</%block>
