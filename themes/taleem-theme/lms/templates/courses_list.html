<%page expression_filter="h"/>
<%namespace name='static' file='static_content.html'/>
<%!
  from django.utils.translation import ugettext as _
  from student.models import CourseEnrollment
  from openedx.custom.wishlist.models import Wishlist
  from django.urls import reverse
%>

<%
  if user.is_authenticated:
    fav_courses = Wishlist.fav_course_id_list(user)
  else:
    fav_courses = []

  filter_icons = {
    "provider": "la-landmark",
    "subject": "la-book",
    "stage": "la-stream",
    "language": "la-language",
  }
%>
<%block name="header_extras">
  <link rel="stylesheet" href="${static.url('assets/vendor/star-rating/star-rating.min.css')}">
  <link rel="stylesheet" href="${static.url('assets/css/autoComplete.min.css')}">
  <link rel="stylesheet" href="${static.url('css/filters.css')}">
  <style>
    .highlighted-courses .courses, .find-courses .courses {
      padding: 20px 0 15px;
    }
    #suggestion-msg {
      color: #856404;
      background-color: #fff3cd;
      border-color: #ffeeba;
      margin-bottom: 20px;
      display: none;
    }
    #suggestion-msg .suggestion-cat{
      font-weight: 700;
    }
    /******* AutoComplete *******/
    .autoComplete_wrapper > input:focus {
      border: 0;
      box-shadow: none;
    }
    .autoComplete_wrapper > input:focus-visible {
      outline: #281958 auto 1px;
    }
    .autoComplete_wrapper > ul {
      overflow: hidden auto;
      margin-top: 1px;
      border-radius: 5px;
      right: -20px;
      left: -20px;
      max-height: 300px;
    }
    .autoComplete_wrapper > ul > li mark {
      background-color: transparent;
      color: #A445B0;
      font-weight: bold;
    }
  </style>
</%block>

<section class="courses-container highlighted-courses">
  % if settings.FEATURES.get('COURSES_ARE_BROWSABLE'):

    % if filters_data:
    <section class="courses-filter mt-3">
      <h1 class="filters-title"><i class="las la-lg la-filter mx-1"></i> ${_('Filter Courses')}</h1>
      <div id="search-filter" class="filter-item">
        <input id="filters-auto-complete" class="filter-input" type="text" name="search" placeholder="${_('Search for a course')}">
      </div>
      <div id="filter-accordion" class="filter-accordion">
        %for filter_key, filter_items in filters_data.items():
        <div class="filter-card" data-filter="${filter_key}">
          <div class="filter-header collapsed" id="${filter_key}-filter-h" data-toggle="collapse" data-target="#${filter_key}-filter" aria-expanded="false" aria-controls="${filter_key}-filter">
            <h3 class="filter-title">
              <i class="las la-lg ${filter_icons[filter_key.lower()] if filter_key.lower() in filter_icons.keys() else 'la-filter'} mx-1"></i>
              % if LANGUAGE_CODE == "ar" and filter_items["category_name_in_arabic"]:
              ${filter_items["category_name_in_arabic"]}
              % else:
              ${filter_items["category_name"]}
              % endif
              <span id="${filter_key}-counter" class="filetr-count">0</span>
            </h3>
          </div>
          <div id="${filter_key}-filter" class="collapse" aria-labelledby="${filter_key}-filter-h" data-parent="#filter-accordion">
            <div class="filter-body">
              %for filter_item in filter_items["category_filters"]:
              <div class="form-check">
                <input class="form-check-input filter-input" type="checkbox" name="${filter_key}[]" value="${filter_item['id']}" id="${filter_key}-${filter_item['id']}">
                <label class="form-check-label" for="${filter_key}-${filter_item['id']}">
                  % if LANGUAGE_CODE == "ar" and filter_item["value_in_arabic"]:
                  ${filter_item["value_in_arabic"]}
                  % else:
                  ${filter_item["value"]}
                  % endif
                </label>
              </div>
              %endfor
            </div>
          </div>
        </div>
        %endfor
      </div>
      <div id="sort-filter" class="filter-item">
        <h3 class="filter-label"><i class="las la-lg la-sort mx-1"></i> ${_('Sort')}</h3>
        <select class="filter-input" name="sort">
            <option value="" selected></option>
            <option value="start_date">${_('By Date')}</option>
            <option value="rating">${_('By Rating')}</option>
            <option value="popular">${_('By Popularity')}</option>
            <option value="atoz">${_('Alphabetically A-Z')}</option>
            <option value="ztoa">${_('Alphabetically Z-A')}</option>
        </select>
      </div>
      <a class="filter-btn" id="filter-btn"><i class="las la-sync mx-1"></i>${_('Filter')}</a>
    </section>
    % endif

    <section class="courses container-fluid" id="courses-wrapper">
      <div id="suggestion-msg" class="alert alert-warning" role="alert">
        ${_("We couldn't find any courses for the selected filters. we will show you courses for")} :
        <span class="suggestion-cat"></span>
      </div>
      <div class="courses-listing row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 justify-content-center">
        ## limiting the course number by using HOMEPAGE_COURSE_MAX as the maximum number of courses
        %for course in courses[:homepage_course_max]:
          <%
            is_favorite = course.id in fav_courses
            if user.is_authenticated:
              is_enrolled = CourseEnrollment.is_enrolled(user, course.id)
            else:
              is_enrolled = False
          %>
          <div class="course-list-item col my-3">
            <%include file="course.html" args="course=course, is_favorite=is_favorite, is_enrolled=is_enrolled, course_ratings=course_ratings" />
          </div>
        %endfor
      </div>
      <div class="pagination">
        <span id="filter-prev" class="prev"><i class="las la-angle-left"></i></span>
        <div id="filter-pages" class="pages">
            <span class="page active" data-page="1">1</span>
            %for p in range(2, total_num_of_pages+1):
              <span class="page" data-page="${p}">${p}</span>
            %endfor
        </div>
        <span id="filter-next" class="next"><i class="las la-angle-right"></i></span>
      </div>
      <div class="loading-block"><i class="las la-4x la-spin la-sync"></i></div>
    </section>
    ## in case there are courses that are not shown on the homepage, a 'View all Courses' link should appear
    % if homepage_course_max and len(courses) > homepage_course_max:
    <div class="courses-more">
      <a class="courses-more-cta" href="${marketing_link('COURSES')}"> ${_("View all Courses")} </a>
    </div>
    % endif
  % endif

  <%include file="course-tpl.html"/>
</section>

<%block name="js_extra">
  <script type="text/javascript" src="${static.url('assets/vendor/star-rating/star-rating.min.js')}"></script>
  <!-- Page level custom js -->
  <script type="text/javascript">
    function initStars(initialRating, startElementId, isUserEnrolled){
      var $startElement = $(document.getElementById(startElementId));

      try {
        // Unload
        $startElement.starRating('unload');
      } catch(err) {console.log('Skip unloading');}
      // Init rating

      $startElement.starRating({
          initialRating: initialRating,
          starSize: 20,
          useFullStars: true,
          disableAfterRate: false,
          starShape: 'rounded',
          activeColor: '#Ff9933',
          hoverColor: '#Ff9933',
          ratedColor: '#Ff9933',
          useGradient: false,
          readOnly: !isUserEnrolled,
          callback: function(currentRating, $el){
              jQuery.ajax({
                  type: "POST",
                  url: $el.data('courseratingurl'),
                  data: {
                    stars: currentRating,
                  },
                  success: function (res) {
                      $el.parent().parent().find('.avg-rating').text(res.avg);
                      $el.parent().parent().find('.num-reviews').text(res.count);
                  },
              });
          }
      });
    }
    $(document).ready(function() {
      $( ".course-rating" ).each(function() {
          initStars($(this).data('userrating'), $(this).attr('id'), $(this).data('isuserenrolled'));
      });
    });
  </script>

  <script type="text/javascript" src="${static.url('assets/js/autoComplete.min.js')}"></script>
  <script type="text/javascript" src="${static.url('assets/js/filters.js')}"></script>
  <script type="text/javascript">
    var filterAutoCompleteId = "filters-auto-complete";
    var filterAutoCompletePlaceholder = "${_('Search for a course')}";
    var filterAutoCompleteLoading = "${_('Loading')}";
    var searchURL = "${reverse('auto_complete_course_search')}";
    $(document).ready(function () {
      // The autoComplete.js Engine instance creator
      const autoCompleteJS = new autoComplete({
        selector: "#" + filterAutoCompleteId,
        placeHolder: filterAutoCompletePlaceholder,
        data: {
          src: async (query) => {
            try {
              console.log("search for courses : " + query);
              // Loading placeholder text
              document.getElementById(filterAutoCompleteId).setAttribute("placeholder", filterAutoCompleteLoading);
              // Fetch Data from external Source
              const source = await fetch(searchURL + "?search=" + query);
              // Data is array of `Objects` | `Strings`
              const data = await source.json();
              // Post Loading placeholder text
              document.getElementById(filterAutoCompleteId).setAttribute("placeholder", autoCompleteJS.placeHolder);
              // Returns Fetched data
              return data.results;
            } catch (error) {
              return error;
            }
          },
          keys: ["name"]
        },
        threshold: 3,
        debounce: 300,
        resultsList: {
          noResults: true,
          maxResults: 15,
          tabSelect: true
        },
        resultItem: {
          highlight: true
        }
      });
      autoCompleteJS.input.addEventListener("selection", function (event) {
        const feedback = event.detail;
        autoCompleteJS.input.blur();
        // Prepare User's Selected Value
        const selection = feedback.selection.value[feedback.selection.key];
        // Replace Input value with the selected value
        autoCompleteJS.input.value = selection;
        filterLoadCourses([], selection, filterSort, 1);
      });
    });
  </script>

  <!-- filters scripts -->
  <script type="text/javascript">
    // set total number of pages
    var filtertAllPages = ${total_num_of_pages};
    var filterCoursesDefaultImage = "${static.url('images/placeholder.png')}";

    var origFilterAddCourse = filterAddCourse;
    filterAddCourse = function(course) {
      console.log(course);
      let list = $("#courses-wrapper .courses-listing");
      let template = $.trim($('#course-template').html());

      // update course data
      let clone = template.replace(/{{id}}/ig, course.id);
      clone = clone.replace(/{{display_name_with_default}}/ig, course.display_name_with_default);
      clone = clone.replace(/{{display_org_with_default}}/ig, course.display_org_with_default);
      clone = clone.replace(/{{display_number_with_default}}/ig, course.display_number_with_default);
      clone = clone.replace(/{{course_image_url}}/ig, course.course_image_url);
      clone = clone.replace(/{{course_date_string}}/ig, course.course_date_string);
      clone = clone.replace(/{{advertised_start}}/ig, course.advertised_start);
      clone = clone.replace(/{{course_link}}/ig, '/courses/' + course.id + '/about');

      clone = clone.replace(/{{course_rating_url}}/ig, '/taleem/course-rating/' + course.id);
      clone = clone.replace(/{{user_rating}}/ig, ((course.user_rating == 0 ) ? course.avg_rating : course.user_rating));
      clone = clone.replace(/{{avg_rating}}/ig, course.avg_rating);
      clone = clone.replace(/{{num_reviews}}/ig, course.num_reviews);

      clone = $(clone);
      if(course.advertised_start !== null) {
        clone.find('.no-advertised_start').remove();
      } else {
        clone.find('.advertised_start').remove();
      }

      if(course.is_enrolled) {
        clone.find('.wishlist-btn').remove();
        clone.find('.course-rating').data('isuserenrolled', true);
      }
      else if(course.is_favorite) {
        clone.find('.wishlist-icon').removeClass('lar').addClass('las');
      }

      clone.find('.course-cover>img').on("error", function (event) {
        this.src = filterCoursesDefaultImage;
      });

      // add course to the list
      list.append(clone);
    }

    var origFilterUpdatePagination = filterUpdatePagination;
    filterUpdatePagination = function(total, current) {
      let pagination = $("#filter-pages");

      // remove all pages
      pagination.empty();
      for (let page = 1; page <= total; page++) {
        let $p = $("<span>", {"class": "page", "data-page": page});
        $p.text(page);
        if(page == current) $p.addClass("active");
        $p.click(function(){
          let page = parseInt($(this).data("page"));
          if(page > 0 && page <= filtertAllPages) {
            filterLoadCourses(filtersSelected, filterSearch, filterSort, page);
          }
        });
        pagination.append($p);
      }
    }

    var origFilterUpdateSuggestionMsg = filterUpdateSuggestionMsg;
    filterUpdateSuggestionMsg = function(isSuggestion, category) {
      if(isSuggestion) {
        $("#suggestion-msg .suggestion-cat").text(category);
        let values = $(".courses-filter #"+category  +"-filter input:checkbox:checked+.form-check-label").map(function () {
          return $(this).text().replaceAll("\n", "").trim();
        }).get().join(', ');
        if(values != "") {
          $("#suggestion-msg .suggestion-cat").text(values);
        }
        $("#suggestion-msg").show();
      } else {
        $("#suggestion-msg").hide();
      }
    }

    var origFilterCoursesUpdated = filterCoursesUpdated;
    filterCoursesUpdated = function() {
      // wishlist event listener
      $("#courses-wrapper .wishlist-icon").click(function(e){
        var course_id = $(this).data('course_id');
        var url = ($(this).hasClass('las')) ? '/api/wishlist/remove/': '/api/wishlist/add/';
        var method = ($(this).hasClass('las')) ? 'DELETE': 'POST';
        var $el = $(this);
        jQuery.ajax({
          type: method,
          url: url,
          data: {'course_key': course_id},
          success: function (res) {
            $el.toggleClass('las');
            $el.toggleClass('lar');
          },
          error: function (xhr) { // if error occured
            alert('Something went wrong!');
          }
        });
      });

      // Init course rating
      $("#courses-wrapper .course-rating").each(function() {
        initStars($(this).data('userrating'), $(this).attr('id'), $(this).data('isuserenrolled'));
      });
    }
  </script>
</%block>
