<%page expression_filter="h"/>
<%!
  import json
  from openedx.core.djangolib.markup import HTML
  from django.utils.translation import ugettext as _
  from openedx.core.djangolib.js_utils import js_escaped_string, dump_js_escaped_json
%>
<%inherit file="../main.html" />

<%namespace name='static' file='../static_content.html'/>

<%block name="bodyclass">view-in-course view-courseware courseware</%block>

<%block name="header_extras">
  <%static:css group='style-course-vendor'/>
  <%static:css group='style-course'/>
  <script type="text/javascript" src="${static.url('js/jquery.autocomplete.js')}" async></script>
  <script type="text/javascript" src="${static.url('js/src/tooltip_manager.js')}" async></script>

  <link href="${static.url('css/vendor/jquery.autocomplete.css')}" rel="preload" type="text/css">

  ${HTML(problems[0].render('student_view').head_html())}
  <style>
  .swal-button {background-color: #7cd1f9 !important; background-image: none; box-shadow: none; text-shadow: none;}
  .swal-button:not([disabled]):hover {    background-color: #78cbf2 !important; background-image: none; box-shadow: none; text-shadow: none;}
  .taleem-theme .course-wrapper {border: none !important;}
  .content-wrapper {background-color:#fff;}
  .problem-action-buttons-wrapper {display: none;}
  .problem .submission-feedback {display: none !important;}
  .btn {background-image: none;}
  .btn-primary:hover, .btn-brand:hover, .btn-primary.is-hovered, .is-hovered.btn-brand, .btn-primary:focus, .btn-brand:focus, .btn-primary.is-focused, .is-focused.btn-brand {
    border-color: #fc0;
    background-color: #fc0 !important;
    color: #fcfcfc;
    background-image: none !important;
  }
  #overlay, #loading-overlay {
    position: fixed;
    display: none;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0,0,0,1);
    z-index: 2;
    cursor: pointer;
  }
  #overlay-text, #loading-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    font-size: 50px;
    line-height: 50px;
    color: white;
    transform: translate(-50%,-50%);
    -ms-transform: translate(-50%,-50%);
  }
  #exam-timer {
    font-size: 24px;
    background-color: #f7f4f4;
    padding: 6px 20px;
    border-radius: 5px;
  }
  #connection-status {
    display: inline-block;
    height: 24px;
    width: 24px;
    border-radius: 50%;
  }
  .exam-problem {display: none;}
  .xmodule_display.xmodule_ProblemBlock div.problem .notification {float: none !important;}
  </style>
</%block>

<%block name="pagetitle">${_("Offline Exam")}</%block>

<div class="exam p-4">

  <div class="row">

    <div class="col-6">
      <div class="connection-wrapper p-4">
        <div class="connection">
          <span class="mr-2 bg-success" id="connection-status"></span>
          <span class="font-weight-bold">${_("Network Connection")}</span>
        </div>
      </div>
    </div>

    <div class="col-6">
      <div class="timer-wrapper p-4">
        <div class="timer text-right">
          <span class="font-weight-bold" id="exam-timer">00:00:00</span>
        </div>
      </div>
    </div>

  </div>

  <div class="exam-problems">
    % for problem in problems:
    <div class="exam-problem">
      <div class="course-wrapper chromeless">
        <section class="course-content" id="course-content"\
        % if enable_completion_on_view_service:
          data-enable-completion-on-view-service="true" \
        % else:
          data-enable-completion-on-view-service="false" \
        % endif
        style="display: block; width: auto; margin: 0;"
        >
          <main id="main" tabindex="-1" aria-label="Content">
            ${HTML(problem.render('student_view').body_html())}
            </main>
        </section>
      </div>
    </div>
    % endfor
  </div>

    <nav class="sequence-bottom text-right mt-2" aria-label="Section">
      <div class="row">
        <div class="col-7">
          <button class="btn btn-primary sequence-nav-button button-previous" disabled>
            <span class="icon fa fa-chevron-prev" aria-hidden="true"></span>
            <span class="ml-2">${_("Previous")}</span>
          </button>

          <button class="btn btn-primary sequence-nav-button button-next">
            <span class="mr-2">${_("Next")}</span>
            <span class="icon fa fa-chevron-next" aria-hidden="true"></span>
          </button>
        </div>

        <div class="col-5">
          <button class="btn btn-primary exam-submit">
            <span class="icon fa fa-stop-circle" aria-hidden="true"></span>
            <span class="ml-2">${_("Stop & Submit Exam")}</span>
          </button>
        </div>

      </div>

    </nav>

</div><!-- exam-->

<div id="overlay">
    <div id="overlay-text">${_("Your browser doesn't support offline exam. Please use the latest version of Google Chrome.")}</div>
</div>

<div id="loading-overlay">
    <div id="loading-icon">
        <i class="las la la-spin la-sync"></i>
    </div>
</div>

<div class="hidden" id="problem-submission-notification">
    <div class="notification general notification-submit" tabindex="-1">
        <span class="icon fa fa-info-circle" aria-hidden="true"></span>
        <span class="notification-message">${_("Answer submitted.")}
        </span>
    </div>
</div>

<%block name="js_extra">
  <script type="text/javascript" src="${static.url('common/js/vendor/jquery.scrollTo.js')}" async></script>
  <script type="text/javascript" src="${static.url('js/vendor/flot/jquery.flot.js')}" async></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

  <%static:js group='courseware'/>

  <%include file="/mathjax_include.html" args="disable_fast_preview=True"/>

  ${HTML(problems[0].render('student_view').foot_html())}

  <script>

  /* Timer */
  let timerId = null;
  let timerTick = 0;
  let secondsLeft = 0;
  let alarms = [];
  let grace_period_secs = 5;
  let low_threshold_sec = 300;
  let critically_low_threshold_sec = 60;

  var getFormattedRemainingTime = function(secondsLeft) {
      var secsLeft = secondsLeft,
          hours, minutes, seconds;
      /* since we can have a small grace period, we can end in the negative numbers */
      if (secondsLeft < 0) {
          secsLeft = 0;
      }

      hours = Math.floor(secsLeft / 3600);
      minutes = Math.floor(secsLeft / 60) % 60;
      seconds = Math.floor(secsLeft % 60);

      return (hours < 10 ? '0' + hours : hours)
          + ':' + (minutes < 10 ? '0' + minutes : minutes)
          + ':' + (seconds < 10 ? '0' + seconds : seconds);
  }

  var getRemainingTimeState = function(secondsLeft) {
      if (secondsLeft > low_threshold_sec) {
          return null;
      } else if (secondsLeft <= low_threshold_sec &&
                 secondsLeft > critically_low_threshold_sec) {
          // returns the class name that has some css properties
          // and it displays the user with the waring message if
          // total seconds is less than the low_threshold value.
          return 'text-warning';
      } else {
          // returns the class name that has some css properties
          // and it displays the user with the critical message if
          // total seconds is less than the critically_low_threshold_sec value.
          return 'text-danger';
      }
  }

  var updateRemainingTime = function() {
      timerTick += 1;
      secondsLeft -= 1;

      if (alarms.indexOf(parseInt(secondsLeft)) > -1) {
        swal({
          title: "${_('Alarm')}",
          text: parseInt(secondsLeft / 60) + "${_(' minutes remaining.')}",
          icon: "warning",
          button: "${_('OK')}"
        });
      }

      $('#exam-timer').attr('class');
      let newState = getRemainingTimeState(secondsLeft);

      if (newState !== null && !$('#exam-timer').hasClass(newState)) {
          $('#exam-timer').removeClass('text-warning text-danger');
          $('#exam-timer').addClass('low-time ' + newState);
      }

      $('#exam-timer').html(getFormattedRemainingTime(secondsLeft));
      if (secondsLeft <= -grace_period_secs) {
          clearInterval(timerId); // stop the timer once the time finishes.
          timerId = null;
          var submitButton = document.getElementsByClassName('exam-submit')[0];

          if (!submitButton.disabled) {
              submitButton.click();
          }

          // decide what to do with the page when the timer expired
      }
  }
  /* Timer End */

  // mark the problem submission
  var markProblemSubmission = function() {
    $(".exam-problem:visible .problem").append($("#problem-submission-notification").html());
    $(".exam-problem:visible .problem button.submit")
        .attr('disabled', true)
        .attr("data-should-enable-submit-button", "False")
        .data("should-enable-submit-button", "False");
  }

  // Block AJAX calls
  var blockAjaxCalls = function() {
    blockAJAX = true;
    $.ajaxSetup({
      beforeSend: function (jqXHR, settings) {
        if (blockAJAX == true){
          if(settings.url.endsWith("/handler/xmodule_handler/problem_check")) {
            let entry = {
              url: settings.url,
              data: settings.data,
              timestamp: Date.now()
            };
            addOfflineAjax(entry);
            markProblemSubmission();
          }
          jqXHR.abort(event);
        }
      }
    });
  }

  /* Attempt */
  var startAttempt = function() {
    $.ajax({
      type: "POST",
      url: "${attempt_status_endpoint}",
      data: {'status': 'started'},
      success: function (res) {
        secondsLeft = res.time_remaining_seconds;
        alarms = res.alarms;
        timerId = setInterval(updateRemainingTime, 1000);
        blockAjaxCalls();
      },
      error: function (xhr) { // if error occured
        console.error(xhr.statusText + xhr.responseText);
      },
      complete: function () {
        $("#loading-overlay").hide();
      },
    });
  }

  var endAttempt = function() {
    $.ajax({
      type: "POST",
      url: "${attempt_status_endpoint}",
      data: {'status': 'submitted'},
      success: function (res) {
        location.reload();
      },
      error: function (xhr) { // if error occured
        console.error(xhr.statusText + xhr.responseText);
      },
      complete: function () {
        $("#loading-overlay").hide();
      },
    });
  }
  /* End Attempt */


  /* DB */
  const DB_NAME = 'Ta3leem';
  const DB_VERSION = 3;
  const DB_STORE_NAME = 'offline';
  var db;

  var initDatabase = function() {
    let dbReq = indexedDB.open(DB_NAME, DB_VERSION);
    dbReq.onsuccess = function(event) {
      db = event.target.result;
      clearObjectStore();
    }
    dbReq.onerror = function(event) {
      alert('error opening database ' + event.target.errorCode);
    }
    dbReq.onupgradeneeded = function(event) {
      db = event.target.result;
      db.createObjectStore(DB_STORE_NAME, {autoIncrement: true});
    }
  }

  var getObjectStore = function(store_name, mode) {
    var tx = db.transaction(store_name, mode);
    return tx.objectStore(store_name);
  }

  var clearObjectStore = function() {
    let store = getObjectStore(DB_STORE_NAME, 'readwrite');
    let req = store.clear();
    req.onerror = function (evt) {
      console.error("clearObjectStore:", evt.target.errorCode);
    };
  }

  // Add Ajax call to db
  var addOfflineAjax = function(entry) {
    let store = getObjectStore(DB_STORE_NAME, 'readwrite');
    let req = store.add(entry);
    req.onerror = function(event) {
      alert('error submitting answer ' + event.target.errorCode);
    }
  }

  /* End DB */

  /* Render questions */
  var renderQuestions = function() {
    $(".exam-problem").each(function(index) {
      if(index !=0 ) {
        //var $el = $(this).find(".problems-wrapper").first();
        //$el.html($el.data("content"));
        var courseContentElement = $(this).find('.course-content').first();
        var blocks = XBlock.initializeBlocks(courseContentElement);
      }
    });
  }
  /* End Render questions */

  /* Replay AJAX calls */
  var replayAjaxCalls = function() {
    $("#loading-overlay").show();
    blockAJAX = false;
    var pendingEntries = 0;
    let store = getObjectStore(DB_STORE_NAME, 'readonly');
    store.getAll().onsuccess = function(event) {
      var entries = event.target.result;
      $.each(entries, function(i, entry){

        $.ajax({
          type: "POST",
          url: entry.url,
          data: entry.data,
          async: false,
          success: function(res) {
            console.log("problem submitted");
          }
        });

      });

      endAttempt();

    };
  }
  /* End replay AJAX calls */

  $(document).ready(function(){
    if(window.indexedDB) {

      $("#loading-overlay").show();

      initDatabase();
      renderQuestions();

      $(".exam-problem").first().show();

      startAttempt();

      if ($(".exam-problem").length < 2) {
        $(".button-next").attr('disabled', true);
      }
      $(".button-next").click(function(){
        $(".exam-problem:visible").next().show().prev().hide();
        $(".button-previous").attr('disabled', false);
        if ($(".exam-problem:visible").next().length == 0) {
          $(".button-next").attr('disabled', true);
        }
      });
      $(".button-previous").click(function(){
        $(".exam-problem:visible").prev().show().next().hide();
        $(".button-next").attr('disabled', false);
        if ($(".exam-problem:visible").prev().length == 0) {
          $(".button-previous").attr('disabled', true);
        }
      });

      window.addEventListener('offline', function(e) {
        $("#connection-status").removeClass("bg-success").addClass("bg-danger");
        $(".exam-submit").attr('disabled', true);
      });
      window.addEventListener('online', function(e) {
        $("#connection-status").removeClass("bg-danger").addClass("bg-success");
        $(".exam-submit").attr('disabled', false);
      });

      $(".exam-submit").click(function(){
        replayAjaxCalls();
      });

    } else {

      $("#overlay").show();

    }

  });

  </script>

</%block>
