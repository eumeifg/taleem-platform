// Once generated by CoffeeScript 1.9.3, but now lives as pure JS
/* eslint-disable */
(function() {
  $(function() {
    // Page loaded now configure the LRS.
    window.addEventListener("load", function(){
      var conf = {
        "endpoint" : this.lrs_endpoint,
        "auth" : "Basic " + this.lrs_authtoken
      };
      ADL.XAPIWrapper.changeConfig(conf);
    });

    /**
     * AJAX call to LRS for sending H5P statements.
     */
    window.addEventListener('message', function receiveMessage(event) {
      event.preventDefault();

      var data = event.data;      
      if (data.result === undefined) {
        return; // Only handle messages with result
      }

      // Update the actor name and mbox, Who performed the activity.
      delete data.actor["account"];
      data.actor['name'] = this.$$username;
      data.actor['mbox'] = 'mailto:' + this.$$user_email;
      
      // Extend the statement context with some more useful information.
      data['context']['extensions'] = {
        "http://id.tincanapi.com/extension/target": this.$$xapi_context_extension
      };
      data['context']['instructor'] = this.$$instructor;

      // Send statement to LRS.
      ADL.XAPIWrapper.sendStatement(data, function(err, res, body) {
        if (err.status !== '200') {
            return;
        }

        ADL.XAPIWrapper.log("[" + body.id + "]: " + res.status + " - " + res.statusText);
      });

    } , false);
  })
}).call(this);
